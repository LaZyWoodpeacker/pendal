# Общее

[Предварительное ТЗ интеграции с учетной системой (УС)](tz.md)

### Переменные окружения

```
DB_SERVER=
DB_BASE=
DB_USER=
DB_PASSWORD=
DB_PORT=
DIADOC_USER_ID=
DIADOC_USER=
DIADOC_PASSWORD=
DIADOC_OUR_BOXID=
DIADOC_OUR_BOXGUID=
DIADOC_OUR_ORGIDGUID=
DIADOC_OUR_ORGID=
DIADOC_OUR_INN=
DIADOC_OUR_KPP=
DIADOC_OUR_FULLNAME=
DIADOC_OUR_SHORTNAME=
DIADOC_OUR_FNSPARTICIPANTID=
SUBSCRIBER_KEY=
SUBSCRIBER_CER=
SUBSCRIBER_PASS=
```

# Общее поведение

### Модуль Task обрабатывает задачи в цикле

1. Приходит заявка по факту оплаты
   1. Обязательны все реквизиты валидируются
      - Счета контрагентов (наличие)
      - Номер платёжного документа и дата (наличие)
      - Данные товаров ( НДС , id )
   2. В случае невалидных **Создаётся задача на уточнение МП**
   3. В случае валидных **Создаётся задача на создание**
2. Проверяет соглашения о документообороте между нами и контрагентами
   1. В случае отсутствия
      1. **Создаётся задачи на уточнение МП**
      2. **Создаётся задача на информирование МП**
      3. **Создаётся задача на отсылку приглашения**
3. **Создаётся задача на отправку в УС**
   1. При подтверждении получения **Создаётся задача на получение статуса от УС**
4. После получения статусов **Создаётся задача на проверку подписания ЭДО**
5. После подписания **Создаётся задача на создание закрывающих в УС**
6. При успешном выполнение **Создаётся задача на получение статуса от УС**
7. После подписания и доставки **Создаётся задача на проверку подписания ЭДО**
8. При успешном подписании **Создаётся задача на информирование МП**

# Описание репозитория

### Модуль для работы с заявками

> src/bid

### Модуль для работы с диадоком

> src/diadoc

### Общие библиотеки

> src/lib

> src/lib/signByOpenSsl.ts

Подписывает документ по GOST-12 через OpenSSL(Требуется установка алгоритмов и правка конфига)

### Электронная подпись для разработки

> keys

### Настройки для разработки

> elasticsearch

### Модуль эмуляции работы УС для разработки

> src/onec

### Модуль логирования

> src/pendal-logger

Логирует в elasticsearch асинхронно с буфером

### Основной модуль обработки задач

> src/task

### Общие типы

> src/types

### Адаптер и gateway вебсокетов для АРМ

> src/websocket.gateway.ts
> src/websocket.adapter.ts

### Подымает окружение для разработки

> docker-compose.yml

- elasticsearch
- postgres
- kibana

> init.sql

Инициализация базы для разработки
